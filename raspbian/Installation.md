# Raspbian installieren

... und grundlegend konfigurieren.

## Betriebssystemdatenträger erstellen

Führe auf einem Ubuntu-Desktop-System nacheinander folgende Schritte aus:

* Lade das neueste Raspbian (Lite) herunter.
* Entpacke die .zip-Datei.
* Lege eine SD-Card ein.
* Starte 'Anwendungen anzeigen' -> 'Hilfsprogramme' -> 'Laufwerke'.
* Markiere das Laufwerk für die SD-Card.
* Gehe zu 'Drei waagerechte Striche' oben Links im Programmfenster.
* Klicke 'Laufwerksabbild wiederherstellen...'.
* Wähle im Dialog die entpackte .img-Datei.
* Klicke 'Wiederherstellung starten'.

Nach ca. 2 Minuten sollte das Image auf die SD-Card geschrieben sein.

## Konfiguration *out of the box*

* Markiere die nun vorhandene boot-Partition.
* Klicke Dreieck für 'Ausgewählte Partition einhängen'.
* Klicke auf den blau gefärbten Link hinter 'Eingehängt in'.

Im Dateimananger werden die Dateien der boot-Partition aufgelistet.

* Rechtsklick in freien Ordnerbereich -> 'In Terminal öffnen'.
* Im Terminal eingeben: `$ sudo touch ssh`
* Anfügen an Datei 'cmdline.txt': `ip=192.168.100.100:::255.255.255.0::eth0:off`
* Alle Dateien und Programme schließen, die auf die boot-Partition zugreifen.
* Klicke auf Quadrat im Programm 'Laufwerke' um die boot-Partition auszuhängen.
* Entnehme die SD-Card aus dem Ubuntu-Rechner.

Bemerkung:  
Das Netzwerksegment 192.168.100.0 wird in diesem Beispiel unabhängig vom meist
genutzen 192.168.0.0 für administrative Aufgaben verwendet. Da die IPv4
192.168.100.100 direkt über einen Kernel-Paramter erzeugt wird,
ist eine missliche Konfiguration über die üblichen Systemwerkzeuge zumindest
für diese Adresse (fast) ausgeschlossen.

Weiterführende Informationen zum Kernel-Paramter 'ip=':
* [Dokumentation auf kernel.org](https://www.kernel.org/doc/html/latest/admin-guide/nfs/nfsroot.html#kernel-command-line)
* [deutschsprachiges Dokument zum Thema](http://www.netzmafia.de/skripten/hardware/RasPi/RasPi_Install.html#initip)


## Erstes Booten des RaspberryPi und Zugriff mittels ssh

* Lege SD-Card in den RaspberryPi ein und versorge ihn mit Betriebsspannung.
* Richte auf dem Ubuntu-Rechner eine zweite IPv4 (beispielsweise 192.168.100.200) auf dem Ethernet-Interface ein.
* Öffne einen Terminal auf dem Ubuntu-Rechner.
* Im Terminal eingeben: `$ ssh pi@192.168.100.100`
* Das Standardpasswort lautet: **raspberry**

## Standardpasswort deaktivieren / neues Passwort vergeben

Direkt nach dem Login muss das voreingestellte Passwort geändert werden,
denn wenn der RaspberryPi an ein IPv6-Gateway angeschlossen ist, so kann er
im globalen IPv6-Adressraum sofort adressiert werden.

```
pi@raspberrypi:~ $ passwd
Changing password for pi.
Current password: 
New password: 
Retype new password: 
passwd: password updated successfully
```

## Resolver (Standard Nameserver) festlegen

Der RaspPi bezieht seine Resolver in der Grundeinstellung von DHCP-Servern
(IPv4/IPv6) und aus *Router Advertisements* (IPv6). Wer jedoch eigene oder
einfach nur andere Resolver nutzen möchte, muss etwas Hand anlegen.
Im folgenden Beispiel werden die Standard-Resolver auf einem RaspPi
dieser Änderung unterzogen.

Istzustand:
```
$ cat /etc/resolv.conf
# Generated by resolvconf
domain home
nameserver 192.168.0.1
nameserver 2a02:908:2:a::1
nameserver 2a02:908:2:b::1
```
Sollzustand:
```
$ cat /etc/resolv.conf
# Generated by resolvconf
domain home
nameserver 8.8.8.8
nameserver 2001:4860:4860::8888
nameserver 8.8.4.4
nameserver 2001:4860:4860::8844
```
Um die Datei /etc/resolv.conf dauerhaft zu ändern,
können wir den Dienst dhcpcd bemühen:
```
$ sudo su
> mv /etc/dhcpcd.conf /etc/dhcpcd.conf~
> echo static domain_name_servers=8.8.8.8 2001:4860:4860::8888 \
    8.8.4.4 2001:4860:4860::8844 > /etc/dhcpcd.conf
> systemctl restart dhcpcd
> cat /etc/resolv.conf
# Generated by resolvconf
domain home
nameserver 8.8.8.8
nameserver 2001:4860:4860::8888
nameserver 8.8.4.4
nameserver 2001:4860:4860::8844
nameserver 2a02:908:2:a::1
nameserver 2a02:908:2:b::1
```
Der ehemalige IPv4-Resolver 192.168.0.1 wurde durch diese Aktion schon elemeniert.
Nun geht es den beiden IPv6-Resolvern an den Kragen,
die per *Router Advertisement* hartnäckig ihren Weg in die /etc/resolv.conf
finden.
```
> echo name_server_blacklist=2a02:* >> /etc/resolvconf.conf
> resolvconf -u
```
Nach dem Neustart des RaspPi, sollten die eingangs gewünschten Resolver - und ausschließlich diese -
in der Datei /etc/resolv.conf dauerhaft vermerkt sein.

## Statische IP-Adressen vergeben

Der DHCP-Server des lokalen Netzwerkes vergibt bereitwillig IP-Adressen aus seinem Adresspool. Auch der RaspPi bezieht in der Grundkonfiguration seine IP-Adresse(n) auf diese Weise.

Soll der RaspPi eine statische IP zugewiesen bekommen,
kann dies wiedrum über den schon bekannten Dienst dhcpcd geschehen.

Istzustand:
```
$ ip -f inet a s eth0 | grep inet
    inet 192.168.100.100/24 brd 192.168.100.255 scope global eth0
    inet 192.168.0.20/24 brd 192.168.0.255 scope global dynamic noprefixroute eth0
$ ip route
default via 192.168.0.1 dev eth0 proto dhcp src 192.168.0.20 metric 202
192.168.0.0/24 dev eth0 proto dhcp scope link src 192.168.0.20 metric 202
192.168.100.0/24 dev eth0 proto kernel scope link src 192.168.100.100
```
Sollzustand:
```
$ ip -f inet a s eth0 | grep inet
    inet 192.168.100.100/24 brd 192.168.100.255 scope global eth0
    inet 192.168.0.100/24 brd 192.168.0.255 scope global noprefixroute eth0
$ ip route
default via 192.168.0.1 dev eth0 src 192.168.0.100 metric 202 
192.168.0.0/24 dev eth0 proto dhcp scope link src 192.168.0.100 metric 202 
192.168.100.0/24 dev eth0 proto kernel scope link src 192.168.100.100 
```
Vorgehen:
```
$ sudo nano /etc/dhcpcd.conf

# Drei Zeilen hinzufügen:

interface eth0
static ip_address=192.168.0.100/24
static routers=192.168.0.1

$ sudo systemctl restart dhcpcd
```

## IPv6 Privacy Extensions (wieder) aktivieren

Durch das Löschen der originalen /etc/dhcpcd.conf wurden auch die
IPv6 Privacy Extensions vorübergehend deaktiviert. Die Aktivierung stellt
jedoch keine große Hürde dar:
```
$ sudo su; echo slaac private >> /etc/dhcpcd.conf
> systemctl daemon-reload
> systemctl restart dhcpcd
```

## Zusammenfassung
```
$ cat /etc/dhcpcd.conf
static domain_name_servers=8.8.8.8 2001:4860:4860::8888 8.8.4.4 2001:4860:4860::8844
interface eth0
static ip_address=192.168.0.100/24
static routers=192.168.0.1
slaac private

$ cat /etc/resolvconf.conf
# Configuration for resolvconf(8)
# See resolvconf.conf(5) for details

resolv_conf=/etc/resolv.conf
# If you run a local name server, you should uncomment the below line and
# configure your subscribers configuration files below.
#name_servers=127.0.0.1

# Mirror the Debian package defaults for the below resolvers
# so that resolvconf integrates seemlessly.
dnsmasq_resolv=/var/run/dnsmasq/resolv.conf
pdnsd_conf=/etc/pdnsd.conf
unbound_conf=/var/cache/unbound/resolvconf_resolvers.conf
name_server_blacklist=2a02:*
```
